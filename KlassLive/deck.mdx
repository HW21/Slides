import { 
    Invert, Split, SplitRight, Horizontal, FullScreenCode, 
} from '@mdx-deck/layouts'
import { Appear, Notes } from '@mdx-deck/components'
import { Image as BackgroundImage } from '@mdx-deck/components'
import Image from './Image'
import future from '@mdx-deck/themes/future'
import highlight from '@mdx-deck/themes/syntax-highlighter'
export { themes } from './themes'


[KlassLive.HW21.now.sh](https://klasslive.hw21.now.sh)

---
## About Me
* ï£¿ Apple Silicon 2009-19
* [hw21.io](https://hw21.io) 2019-??
* UC Berkeley 2020-??
* [medium.com/@dan_fritchman](https://medium.com/@dan_fritchman)
* [fritch.mn](https://fritch.mn)

---
# Klass.Live

* Live, fun teaching & learning. 
* Built with Jupyter. 
* For sessions just like this. 

---
## Agenda
* The Idea
* High-Risk Demo
* How It Works

---
<BackgroundImage
  src='./img/classroom.jpeg'
  style={{
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
    flexDirection: 'column',
  }}>

## Teaching<br/> & <br/>Learning 

</BackgroundImage>

--- 
<Invert>

### MOOCs <br/> Massive Open Online Courses

<Image src={"./img/mooc.png"}/>

</Invert>

<Notes>

* Stick some content online
* Anyone, anywhere can reach it
* Much lower instruction cost 
* Some limited interactivity

</Notes>

--- 
<Invert>

### MOOCs
<Image src={"./img/mooc_regions.png"}/>

</Invert>

<Notes>

Analogy: MOOC : fast food 

</Notes>

---
<Invert>

### MOOC Interaction
<Image src={"./img/coursera.png"}/>

</Invert>

---
## Artisanal <br/> Farm to Table <br/> Teaching & Learning

<Appear>

### Interactive 
### Live

</Appear>

<Notes>
  Theres a reason thousands come to PyCon etc. 
  Not just to network, but sit in these talks as well
</Notes>

---
<Invert>

## Example: <br/> Lambda School 
<Image src={"./img/lambda_live.png"}/>

</Invert>

---
## *Live* Learning <br/> Some Popular Options

<Appear> 

#### Slides
#### Live Coding
#### Jupyter Notebook

</Appear> 

---
## Slides

### Interactivity: None

---
<Split>

<Image src={"./img/tight-rope.jpeg"}/>

## Live <br/> Coding
### Or, Live <br/> Copy-Paste

</Split>

<Notes>
  The live coding does has a substantial effect though. 
  The act of watching the ideas emerge out of the speakers mind,
  conveys them in a way canned slides just cant. 
</Notes>

---
## Live Copy-Pasting on [YouTube](https://www.youtube.com/watch?v=z-oqYWZhWwU)

<Image src={"./img/jit-compiler.png"}/>

---

<Invert> 

<Split>

<Image src={"./img/jupyter.png"}/>

## Jupyter 

### Sharing: Good
### Interaction: Bad

</Split>

</Invert> 


---
# *Interactive* <br/> Learning

<Appear>

## Some Problems

</Appear>

--- 
<BackgroundImage
  src='./img/install.gif'
  style={{
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
    flexDirection: 'column',
  }}>

## How to Interact

## Step 1: Installation!

</BackgroundImage>

---
## Awesome Interactive Inspiration 

* Interviewing
    * CoderPad
* Web Environments
    * CodePen, CodeSandbox, CodeBunk
* Challenges
    * foo.bar, Advent of Code, Kaggle
* Combinations Thereof
    * CoderByte

---
## Interviewing: [CoderPad](https://coderpad.io)

<Image src={"./img/coderpad.png"}/>

---
## Web Env: [CodeSandbox](https://codesandbox.io)

<Image src={"./img/codesandbox.png"}/>

---
## Web Env: [CodePen](https://codepen.io)

<Image src={"./img/codepen.png"}/>

---
<Invert> 

## Web Env: [CodeBunk](https://codebunk.com)

<Image src={"./img/codebunk.png"}/>

</Invert> 

---
<Invert> 

## Web Env: [repl.it](https://repl.it)

<Image src={"./img/repl-it.png"}/>

</Invert> 

---
## Challenges: [Google FooBar](https://www.google.com/foobar)

<Image src={"./img/foobar-bunny.gif"}/>

---
## Challenges: [Advent of Code](https://adventofcode.com)

<Image src={"./img/advent.png"}/>

---
<Invert> 

## Some of Each: [CoderByte](https://www.coderbyte.com)

<Image src={"./img/coderbyte.png"}/>

</Invert> 

---
## Problem 2: <br/> Keeping Up

```python
def step1(monkey):
    """ Let's write a function 
    that turns a monkey into a wrench. """
    return ...
```

---
## Keeping Up

```python
def step2(monkey):
    """ Now write a function that uses step1 
    to turn a monkey into a whole garage. """
    wrench = stage1(monkey)
    return ...
```

---
# Keeping Up

```python
def step73(monkey):
    """ Write a function that uses steps 1-72,
    to recreate the origins of the universe. """
    after_big_bang = stage72(monkey)
    return ...
```

Once any of stages 1-72 go wrong, <br/> 
you're done. 

---
## Problem 3: Fun! 

---
# Klass.Live 
* Zero Installation
* Always Live 
* Built on Jupyter 

---
# Chapter 2
# Demo Time
# https://klass.live

---

---
# Chapter 3 
# How this Works 

---
<Invert> 

<Image src={"./img/klasslive-summary.png"}/>

</Invert> 

---
<Invert> 

<Image src={"./img/klasslive-app-api.png"}/>

</Invert> 

---
<Invert> 

<Image src={"./img/klasslive-api-server.png"}/>

</Invert> 

--- 
## A Few Lessons 

--- 
## React 

```jsx
class Counter extends Component {
  state = { count: 0 };
  handleClick = () => {
    this.setState({ count: this.state.count + 1});
  }
  render() {
    return <button onClick={this.handleClick}>
      {this.props.name} = {this.state.count}
    </button>;
  }
}
```

Lesson: not goin back 

---
## Declarative React Routing 

```jsx
function AppRouter() {
  return (
    <Router>
        <Route path="/" exact component={Index} />
        <Route path="/about/" component={About} />
        <Route path="/users/" component={Users} />
    </Router>
  );
}
```

Initial reaction: WTF is this? 

---
## Redux

```javascript
function counter(state = 0, action) {
  switch (action.type) {
    case 'INCREMENT':
      return state + 1
    case 'DECREMENT':
      return state - 1
    default:
      return state
  }
}
```

Initial reaction: WTF is this? 

---
## Redux [State Shape](https://redux.js.org/recipes/structuring-reducers/normalizing-state-shape)

```javascript
const blogPosts = [
  {
    id: 'post1',
    author: { username: 'user1', name: 'User 1' },
    body: '......',
    comments: [
      {
        id: 'comment1',
        author: { username: 'user2', name: 'User 2' },
        comment: '.....'
      },
      {
        id: 'comment2',
        author: { username: 'user3', name: 'User 3' },
        comment: '.....'
      }
    ]
  },
  ...
];
```

This is... Bad?

---
## Redux [State Shape](https://redux.js.org/recipes/structuring-reducers/normalizing-state-shape)

```javascript
{
    posts : {
        byId : {
            "post1" : {
                id : "post1",
                author : "user1",
                body : "......",
                comments : ["comment1", "comment2"]
            },
            "post2" : {
                id : "post2",
                author : "user2",
                body : "......",
                comments : ["comment3", "comment4", "comment5"]
            }
        },
        allIds : ["post1", "post2"]
    },
    ...
}
```

This is... Good?


---
## Redux 

```javascript
const updateProblemTitle = (klass, action) => {
    const {problemId, title} = action;
    if (!problemId) return klass;

    const problem = klass.problemsById[problemId];
    if (!problem) return klass;

    return {
        ...klass,
        problemsById: {
            ...klass.problemsById,
            [problemId]: {
                ...problem,
                title: title
            }
        }
    }
};
```

Hate it, but kinda love it.

---
### Paths Not Taken <br/> Next.js

```jsx
export default class Page extends React.Component<Props> {
  static async getInitialProps({ req }: NextPageContext) {
    const userAgent = req ? req.headers['user-agent'] : navigator.userAgent;
    return { userAgent };
  }

  render() {
    const { userAgent } = this.props;
    return <main>Your user agent: {userAgent}</main>;
  }
}
```

---
### Paths Not Taken <br/> MobX

```jsx
class Order {
    @observable price = 0;
    @observable amount = 1;

    constructor(price) {
        this.price = price;
    }

    @computed get total() {
        return this.price * this.amount;
    }
}
```

---
### Lessons: GraphQL

```graphql  
type Klass {
    id: String!,
    owner: User!,
    title: String,
    desc: String,
    problems: [Problem]!,
    scratch: [Cell],
    metadata: JSON,
    notebookMeta: JSON,
}

type Problem {
    title: String,
    desc: String,
    setup: [Cell]!,
    prompt: Cell!,
    solution: Cell!,
    tests: Cell!,
}
```

---
### Lessons: GraphQL

```graphql
query GetOpenKlassSessions {
  klass_sessions {
    title
    problem_num
    host {
      displayName
      email
    }
    user_sessions {
      user {
        displayName
        email
      }
      scores {
        problems
        total
      }
    }
  }
}
```

---
### Lessons: GraphQL

<Image src={"./img/graphql-api.png"}/>

---
### Lessons: GraphQL

```javascript
export const resolvers = {
  Query: {
    klass: (_, arg) => db.get("klasses", arg.id),
    klass_session: (_, arg) => db.get("klass_sessions", arg.id),
  },
  UserSession: {
    user: (obj, arg) => db.getUser(obj.user_id),
    klass_session: (obj, arg) => db.get("klass_sessions", obj.klass_session_id),
    responses: (obj, arg) => obj.response_ids.map(id => db.get("submissions", id))
  },
  User: {
    sessions: (obj, arg) => obj.session_ids.map(k => db.get("user_sessions", k))
  },
  KlassSession: {
    klass: (obj, arg) => db.get("klasses", obj.klass_id),
    host: (obj, arg) => db.getUser(obj.host_id),
    user_sessions: (obj, arg) => obj.user_sessions.map(id => db.get("user_sessions", id))
  },
  Klass: {
    owner: (klass, _) => db.getUser(klass.ownerId)
  },
  JSON: GraphQLJSON
};
```

---
### Lessons: Last Week

#### (Way) Over-Fetching
#### Some Ways GraphQL Goes Wrong

---
<Invert>

### Klass Updates

<Image src={"./img/api-slow.png"}/>

</Invert> 

---
### Debug Queries 

```javascript
resolvers = {
  ...,
  Query: {
        ...,
        health: () => true,
        canary: async () => {
            const inst = await db.models.canaries.findOne();
            return inst.canary;
        },
    },
};
```

---
<Invert>

### Health Query

<Image src={"./img/api-health.png"}/>

</Invert> 

---
<Invert>

### Canary Query

<Image src={"./img/api-canary.png"}/>

</Invert> 

---
<Invert>

### Real Klass Update Query

<Image src={"./img/api-slow.png"}/>

</Invert> 

---
<Invert>

### Problem Review UI

<Image src={"./img/problem-review.png"}/>

Problem 1: *everyone* grabbed all of this 

</Invert> 

---
### Problem 1.1

```jsx 
class KlassSession extends React.Component {

    componentDidMount = async () => {
        // ...
        
        // Set up background reload, every 5s
        this.intervalId = setInterval(reload, 5000);
    };
```

<Appear> 

The problem: what if that request takes more than 5s?

</Appear>

---
### Problem 1.2 
#### Lack of UI "Optimism"

<Appear> 

* Fine when responses come fast 
* Brutal when they take forever 

</Appear>

---
### A Few Cures 
#### Step 1: The Dumb Stuff 

---
<Invert>

### Step 1
#### Stop Grabbing All That Data 

<Image src={"./img/api-user-speedup.png"}/>

</Invert> 

---
### Step 1.1

```jsx 
class KlassSession extends React.Component {

    autoReload = async () => {
        await Sessions.reload();
        this.intervalId = setTimeout(this.autoReload, 5000);
    };

    componentDidMount = async () => {
        // ...
        
        // Set up background reload
        this.intervalId = setTimeout(this.autoReload, 5000);
    };
```

Just wait until requests get done 

---
### Step 2
#### The Smart(er) Stuff 
#### *Speed Up* Grabbing That Data 

---
### Reminder: GraphQL Resolvers 

```javascript
export const resolvers = {
  Query: {
    klass: (_, arg) => db.get("klasses", arg.id),
    klass_session: (_, arg) => db.get("klass_sessions", arg.id),
  },
  UserSession: {
    user: (obj, arg) => db.getUser(obj.user_id),
    klass_session: (obj, arg) => db.get("klass_sessions", obj.klass_session_id),
    responses: (obj, arg) => obj.response_ids.map(id => db.get("submissions", id))
  },
  User: {
    sessions: (obj, arg) => obj.session_ids.map(k => db.get("user_sessions", k))
  },
  KlassSession: {
    klass: (obj, arg) => db.get("klasses", obj.klass_id),
    host: (obj, arg) => db.getUser(obj.host_id),
    user_sessions: (obj, arg) => obj.user_sessions.map(id => db.get("user_sessions", id))
  },
  Klass: {
    owner: (klass, _) => db.getUser(klass.ownerId)
  },
  JSON: GraphQLJSON
};
```

---
### GraphQL [DataLoader](https://github.com/graphql/dataloader)

<Appear> 

* Also from Facebook
* Primary Features
    * Batching 
    *  Per-Request Caching 

</Appear> 

---
### DataLoader Batching 

```javascript
const resolvers = {
    ...,
    UserSession: {
        user: (obj, arg, {loaders}) => loaders.users.load(obj.user_id),
        klass_session: (obj, arg, {loaders}) => loaders.klass_sessions.load(obj.klass_session_id),
        responses: (obj, arg, {loaders}) => loaders.submissions.loadMany(validIds),
    },
};
```

```javascript
const loaders = {
  users: new DataLoader(
    async keys => models.users.find({uid: {$in: keys}});
  ),
  ...
};
```

---
### Some Caching Options <br/> In Order of Preference

<Appear> 

<div>

* Libraries already here 
    * Apollo GraphQL Server 
    * Mongoose ODM 

</div>

<div>

* Other Popular Stuff 
    * Redis 
    * Memcached 

</div>

* Roll Your Own 

</Appear>

---
<Invert> 

### Caching Options
#### Apollo Server  

<Appear> 

<Image src={"./img/apollo-cache-issue.png"}/>

Sad!

</Appear>

</Invert> 

---
### Caching Options 
#### Mongoose ODM 

<Appear>

*(blank image here)* <br/><br/> Sad!

</Appear>

---
### Meta-Lessons from Last Week

<Appear> 

* You can screw up 
* You can screw up several things
* Even if they add up
* But probably not if they *multiply* up

</Appear> 

---
# Chapter 4
## Socratic Method Ambush

---
## Does Anybody Give a Shit? 

<Appear> 

## What Would Help? 

</Appear>

---
## A Few Big Questions 

<Appear>

### Code Execution: How Secure is Secure?
### Env Customization: How Free-Form?
### Language Support

</Appear>

---
## CoderPad Security 

<Image src={"./img/coderpad-hacking-me.png"}/>

---
## CoderPad Security 

```markdown
Hello! Hope you are enjoying CoderPad. I've added this file because a
lot of people have emailed me voicing security concerns. Usually these
concerns are to the tune of "programming language X lets me run Y
system call."

They're not wrong, you can run any system call! Security in CoderPad
happens at the LXC sandbox layer. You are currently in an ephemeral
container that will be destroyed upon your departure. You are welcome
to run any privileged operation you can get your hands on. CoderPad
is, after all, the highest fidelity programming interview tool there
is.

That said, if you do manage to uncover something like privilege
escalation or data created by other users, I want to hear about it.
You can email me at vincent@coderpad.io or tweet at @fulligin, and I
look forward to hearing from you.

Happy hunting!
```

---
## Stuff Not Shown 
(Because it's not there, yet)

<Appear>

### Any Multi-Media
### Custom Language/ Environment
### Testing & Scoring API
### Manual Scoring 
### Notebook/ Repo Export 

</Appear>

---

---

# Backup

---
# Problems
* Every Problem Has:
    * Setup
    * Prompt
    * Solution(s)
    * Tests
* Tests run on server, in Klass container

--- 
# Scoring 
* Pass / Fail
* Manual Scoring 
* Scoring API

---
# Execution
* Jupyter Goal-Fight: Interactive vs Reproducible 
* Always runs "all cells above", plus tests 

---
# Export 
* Binder-Compatible GitHub Repo
* Jupyter Notebook + Env Setup 

---

